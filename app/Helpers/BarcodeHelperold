<?php

namespace App\Helpers;

use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Str;

class BarcodeHelper
{
    public static function generateAndStoreBarcodes($serialNumber, $uploadPath)
    {
        $barcodePathGS128 = '';
        $barcodePathGS1DataMatrix = '';

        // Ensure the upload directory exists
        if (!file_exists(public_path($uploadPath))) {
            mkdir(public_path($uploadPath), 0755, true);
        }

        // Generate GS1-128 barcode using TEC-IT API
        $responseGS128 = Http::get('https://barcode.tec-it.com/barcode.ashx', [
            'data' => $serialNumber,
            'code' => 'GS1-128',
            'translate-esc' => true,
            'multiplebarcodes' => false,
            'showhrt' => false,
        ]);

        if ($responseGS128->successful()) {
            $barcodeImageGS128 = $responseGS128->body();
            $randomNameGS128 = time() . '-' . uniqid() . '.png';
            $barcodePathGS128 = public_path($uploadPath . 'barcode/' . $randomNameGS128);

            // Ensure the 'barcode' directory exists
            if (!file_exists(public_path($uploadPath . 'barcode'))) {
                mkdir(public_path($uploadPath . 'barcode'), 0755, true);
            }

            // Save the file directly to the specified path
            file_put_contents($barcodePathGS128, $barcodeImageGS128);
        }

        // Generate GS1 Data Matrix barcode using TEC-IT API
        $responseGS1DataMatrix = Http::get('https://barcode.tec-it.com/barcode.ashx', [
            'data' => $serialNumber,
            'code' => 'GS1DataMatrix',
            'translate-esc' => true,
            'multiplebarcodes' => false,
        ]);

        if ($responseGS1DataMatrix->successful()) {
            $barcodeImageGS1DataMatrix = $responseGS1DataMatrix->body();
            $randomNameGS1DataMatrix = time() . '-' . uniqid() . '.png';
            $barcodePathGS1DataMatrix = public_path($uploadPath . 'qrcode/' . $randomNameGS1DataMatrix);

            // Ensure the 'qrcode' directory exists
            if (!file_exists(public_path($uploadPath . 'qrcode'))) {
                mkdir(public_path($uploadPath . 'qrcode'), 0755, true);
            }

            // Save the file directly to the specified path
            file_put_contents($barcodePathGS1DataMatrix, $barcodeImageGS1DataMatrix);
        }

        return [
            'barcode_path_gs128' => "{$uploadPath}barcode/{$randomNameGS128}",
            'barcode_path_gs1_datamatrix' => "{$uploadPath}qrcode/{$randomNameGS1DataMatrix}",
        ];
    }
}
